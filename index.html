<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Refuzo Private Installer</title>
    
    <!-- Подключаем WebChannel для связи с программой -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qt5-qwebchannel/5.15.2/qwebchannel.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    
    <style>
        /* === СТИЛИ (Те же самые, что у вас) === */
        :root {
            --bg: #050505;
            --card-bg: rgba(18, 18, 18, 0.95);
            --card-border: rgba(255, 255, 255, 0.08);
            --input-bg: rgba(255, 255, 255, 0.03);
            --input-border: rgba(255, 255, 255, 0.12);
        }
        * { box-sizing: border-box; outline: none; }
        body {
            background: #000; color: #fff; font-family: 'Inter', sans-serif;
            margin: 0; min-height: 100vh; display: flex; align-items: center; justify-content: center;
            overflow-x: hidden; user-select: none;
        }
        .ambient {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000 80%);
        }
        .installer-card {
            width: 640px; min-height: 600px; max-width: 95vw;
            background: var(--card-bg); backdrop-filter: blur(40px);
            border: 1px solid var(--card-border); border-radius: 24px;
            padding: 48px; display: flex; flex-direction: column; gap: 24px; z-index: 10;
            box-shadow: 0 40px 100px -30px rgba(0,0,0,0.8);
        }
        .header { text-align: center; margin-bottom: 10px; }
        .header h1 { margin: 0; font-size: 32px; font-weight: 800; letter-spacing: -1px; }
        .subtitle { font-size: 14px; color: #666; margin-top: 8px; font-weight: 500; }
        
        .file-status { 
            display: flex; align-items: center; justify-content: space-between;
            padding: 18px 24px; background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 16px;
            color: #666; font-size: 14px; font-weight: 600; transition: 0.3s;
        }
        .file-status.active { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.2); color: #fff; }

        .code-input {
            height: 64px; background: var(--input-bg); border: 1px solid var(--input-border);
            border-radius: 16px; padding: 0 24px; font-family: 'JetBrains Mono', monospace;
            font-size: 18px; font-weight: 600; color: #fff; text-align: center;
            letter-spacing: 2px; text-transform: uppercase; transition: 0.3s;
        }
        .code-input:focus { border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.06); }

        .btn-primary { 
            height: 64px; background: #fff; color: #000; border: none; border-radius: 16px;
            font-size: 16px; font-weight: 700; cursor: pointer; width: 100%;
            transition: 0.3s; box-shadow: 0 10px 30px rgba(255,255,255,0.1);
        }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(255,255,255,0.2); }
        .btn-primary:disabled { background: #222; color: #555; cursor: not-allowed; box-shadow: none; transform: none; }

        .console { 
            background: #0a0a0a; border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px; padding: 24px; height: 200px; overflow-y: auto;
            font-family: 'JetBrains Mono', monospace; font-size: 13px; color: #888;
            display: flex; flex-direction: column; gap: 8px;
        }
        .console::-webkit-scrollbar { width: 4px; }
        .console::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="ambient"></div>

    <div class="installer-card">
        <div class="header">
            <h1>Refuzo Installer</h1>
            <div class="subtitle">Private Mod Manager (Client Mode)</div>
        </div>

        <div id="fileStatus" class="file-status">
            <span>Ожидание кода...</span>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
        </div>
        
        <input type="text" id="codeInput" class="code-input" placeholder="ВВЕДИТЕ КОД" maxlength="20">
        <button id="startBtn" class="btn-primary" disabled>ПРОВЕРИТЬ И УСТАНОВИТЬ</button>

        <div id="console" class="console"></div>
    </div>

<script>
    // === CONFIG ===
    const GIST_ID = "e79c3637404354a0b028aa45f3f2dceb";
    const ENCRYPTED_TOKEN = "Z2hwX3QyRjRGNXJ4dU4zUUhQbGhzNU1FVUw5VUpYWWVoWTJCQlFXMg=="; 
    const GH_TOKEN = atob(ENCRYPTED_TOKEN);
    const FILE_NAME = "codes.json";

    // --- Python Bridge Setup ---
    let py_backend = null;

    window.onload = function() {
        if (typeof qt != 'undefined') {
            new QWebChannel(qt.webChannelTransport, function(channel) {
                py_backend = channel.objects.py_backend;
                log("Связь с программой установлена.", 'ok');
            });
        } else {
            log("ВНИМАНИЕ: Открыто в браузере. Установка не сработает.", 'err');
        }
    }

    // --- Logging ---
    function log(msg, type='info') {
        const c = document.getElementById('console');
        const col = type === 'err' ? '#ef4444' : type === 'ok' ? '#10b981' : '#888';
        const ts = new Date().toLocaleTimeString('ru-RU', {hour12:false});
        c.innerHTML += `<div style="margin-bottom:4px"><span style="color:#444">[${ts}]</span> <span style="color:${col}">▸</span> ${msg}</div>`;
        c.scrollTop = c.scrollHeight;
    }

    // --- Main Logic ---
    document.getElementById('codeInput').addEventListener('input', () => {
        document.getElementById('startBtn').disabled = false;
    });

    document.getElementById('startBtn').addEventListener('click', async () => {
        if (!py_backend) return alert("Запустите через программу!");
        
        const code = document.getElementById('codeInput').value.trim();
        if (!code) return;

        document.getElementById('startBtn').disabled = true;
        log("Проверка кода на сервере...", 'info');

        try {
            // 1. Проверяем код через GitHub API (как у вас было)
            const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                headers: { 'Authorization': `token ${GH_TOKEN}` }
            });

            if (!response.ok) throw new Error(`Ошибка сети: ${response.status}`);
            
            const data = await response.json();
            if (!data.files || !data.files[FILE_NAME]) throw new Error("База кодов недоступна");

            const codes = JSON.parse(data.files[FILE_NAME].content);
            const codeData = codes[code];

            if (!codeData) throw new Error("Неверный код!");
            if (codeData.active === false) throw new Error("Код уже был использован!");

            log(`Код принят: ${codeData.mod}`, 'ok');
            document.getElementById('fileStatus').innerHTML = `<span>${codeData.mod}</span><span style="color:#10b981">●</span>`;
            document.getElementById('fileStatus').classList.add('active');

            // 2. Деактивируем код (Сжигаем)
            log("Деактивация кода...", 'info');
            codes[code].active = false;
            
            await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                method: 'PATCH',
                headers: { 
                    'Authorization': `token ${GH_TOKEN}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    files: { [FILE_NAME]: { content: JSON.stringify(codes, null, 2) } }
                })
            });

            // 3. ОТПРАВЛЯЕМ КОМАНДУ В PYTHON НА УСТАНОВКУ
            // Важно: в базе кодов (codeData) должно быть имя файла мода.
            // Предполагаем, что codeData выглядит так: { "mod": "SuperMod", "active": true, "filename": "Mods/Test/Data.zip" }
            // Если "filename" нет, придется хардкодить или передавать имя.
            
            // Передаем имя мода в Python, Python сам скачает нужное
            // (Или передаем URL, если он есть в JSON)
            log("Запуск установки через программу...", 'info');
            
            // ВЫЗОВ PYTHON ФУНКЦИИ
            // Передаем название мода или filename. 
            // Если в JSON гиста нет ссылки на файл, Python должен знать, где искать мод по имени.
            // Для примера передадим имя мода.
            py_backend.installMod(codeData.mod); 

        } catch (e) {
            log(e.message, 'err');
            document.getElementById('startBtn').disabled = false;
        }
    });
    
    // Функция, которую Python может вызвать, чтобы сообщить об успехе
    function onPythonSuccess(msg) {
        log("УСТАНОВКА ЗАВЕРШЕНА!", 'ok');
        document.getElementById('startBtn').innerText = "ГОТОВО";
        document.getElementById('startBtn').style.background = "#10b981";
    }
    
    function onPythonError(msg) {
        log("ОШИБКА УСТАНОВКИ: " + msg, 'err');
        document.getElementById('startBtn').disabled = false;
    }
</script>
</body>
</html>
