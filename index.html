import sys
import os
import requests
import zipfile
import shutil
from io import BytesIO
from PyQt6.QtWidgets import (QApplication, QMainWindow, QMessageBox, 
                             QFileDialog)
from PyQt6.QtCore import QUrl, QThread, pyqtSignal
from PyQt6.QtWebEngineWidgets import QWebEngineView
from PyQt6.QtWebEngineCore import QWebEngineSettings, QWebEnginePage
from PyQt6.QtCore import QSettings

UI_URL = "https://asstrallity-ui.github.io/loader/"

class Installer(QThread):
    done = pyqtSignal(bool, str)
    progress = pyqtSignal(int, str)

    def __init__(self, url, install_path):
        super().__init__()
        self.url = url
        self.install_path = install_path

    def run(self):
        try:
            self.progress.emit(10, "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –º–æ–¥–∞...")
            print(f"üì• –ó–∞–≥—Ä—É–∑–∫–∞: {self.url}")
            
            r = requests.get(self.url, stream=True, timeout=30)
            if r.status_code != 200:
                raise Exception(f"HTTP {r.status_code}")
            
            self.progress.emit(30, "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞...")
            
            temp_dir = os.path.join(os.getcwd(), ".temp_mod")
            if os.path.exists(temp_dir):
                shutil.rmtree(temp_dir)
            os.makedirs(temp_dir)

            with zipfile.ZipFile(BytesIO(r.content)) as z:
                z.extractall(temp_dir)
            
            self.progress.emit(60, "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤...")

            files_copied = 0
            for root, dirs, files in os.walk(temp_dir):
                for file in files:
                    src = os.path.join(root, file)
                    rel_path = os.path.relpath(src, temp_dir)
                    dst = os.path.join(self.install_path, rel_path)
                    
                    os.makedirs(os.path.dirname(dst), exist_ok=True)
                    shutil.copy2(src, dst)
                    files_copied += 1
                    print(f"  ‚úì {rel_path}")
            
            self.progress.emit(90, "–û—á–∏—Å—Ç–∫–∞...")
            shutil.rmtree(temp_dir)
            
            self.progress.emit(100, "–ó–∞–≤–µ—Ä—à–µ–Ω–æ!")
            self.done.emit(True, f"–ú–æ–¥ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –§–∞–π–ª–æ–≤: {files_copied}")

        except zipfile.BadZipFile:
            self.done.emit(False, "–§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è ZIP-–∞—Ä—Ö–∏–≤–æ–º")
        except requests.Timeout:
            self.done.emit(False, "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            self.done.emit(False, f"–û—à–∏–±–∫–∞: {str(e)}")


class CustomWebPage(QWebEnginePage):
    def __init__(self, parent):
        super().__init__(parent)
        self.parent_window = parent

    def javaScriptConsoleMessage(self, level, message, lineNumber, sourceID):
        print(f"[JS]: {message}")
        
        if message.startswith("INSTALL_MOD:"):
            parts = message.replace("INSTALL_MOD:", "").strip().split(":")
            mod_url = parts[0]
            install_mode = parts[1] if len(parts) > 1 else 'sdls'
            
            if mod_url and mod_url != "null" and mod_url.startswith("http"):
                print(f"üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞: {mod_url} (—Ä–µ–∂–∏–º: {install_mode})")
                self.parent_window.start_install(mod_url, install_mode)
        
        elif message.startswith("SET_MODE:"):
            mode = message.replace("SET_MODE:", "").strip()
            self.parent_window.install_mode = mode
            print(f"‚öôÔ∏è –†–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏: {mode}")
        
        elif message == "REFRESH_MODS":
            print("üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–æ–¥–æ–≤")


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        
        self.setWindowTitle("Asstrallity Launcher")
        self.resize(1200, 750)
        
        self.settings = QSettings("Asstrallity", "ModsLoader")
        self.install_mode = 'sdls'  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é sDLS
        
        self.web = QWebEngineView()
        self.custom_page = CustomWebPage(self)
        self.web.setPage(self.custom_page)
        self.setCentralWidget(self.web)
        
        settings = self.web.settings()
        settings.setAttribute(QWebEngineSettings.WebAttribute.JavascriptEnabled, True)
        settings.setAttribute(QWebEngineSettings.WebAttribute.LocalContentCanAccessRemoteUrls, True)
        
        print("üìÅ –ü—É—Ç—å (sDLS): " + os.path.join(os.path.expanduser("~"), "Documents", "packs"))
        print(f"üåê URL: {UI_URL}")
        
        self.web.loadFinished.connect(self.on_load_finished)
        self.web.setUrl(QUrl(UI_URL))
        
        self.js_injected = False

    def get_install_path(self, mode):
        """–ü–æ–ª—É—á–∏—Ç—å –ø—É—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞"""
        if mode == 'sdls':
            # sDLS: –î–æ–∫—É–º–µ–Ω—Ç—ã/packs
            path = os.path.join(os.path.expanduser("~"), "Documents", "packs")
            os.makedirs(path, exist_ok=True)
            return path
        else:
            # No-sDLS: –∏—â–µ–º tanksblitz.exe –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–ø–∫—É Data
            common_paths = [
                "D:\\Games\\Tanks_Blitz",
                "C:\\Games\\Tanks_Blitz",
                "D:\\Games\\World_of_Tanks_Blitz",
                os.path.join(os.environ.get('ProgramFiles', ''), 'Wargaming.net', 'GameCenter', 'wotblitz'),
            ]
            
            for base_path in common_paths:
                exe_path = os.path.join(base_path, "tanksblitz.exe")
                if os.path.exists(exe_path):
                    data_path = os.path.join(base_path, "Data")
                    os.makedirs(data_path, exist_ok=True)
                    print(f"‚úÖ –ù–∞–π–¥–µ–Ω tanksblitz.exe: {base_path}")
                    return data_path
            
            # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            response = QMessageBox.question(
                self, "–ü–∞–ø–∫–∞ –∏–≥—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",
                "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ World of Tanks Blitz.\n–í—ã–±—Ä–∞—Ç—å –ø–∞–ø–∫—É —Å –∏–≥—Ä–æ–π –≤—Ä—É—á–Ω—É—é?",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
            )
            
            if response == QMessageBox.StandardButton.Yes:
                path = QFileDialog.getExistingDirectory(self, "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É —Å tanksblitz.exe")
                if path:
                    data_path = os.path.join(path, "Data")
                    os.makedirs(data_path, exist_ok=True)
                    return data_path
            
            return None

    def on_load_finished(self, success):
        if success and not self.js_injected:
            self.js_injected = True
            print("‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
            
            inject_js = """
            (function() {
                console.log('üîå Python –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–µ–Ω');
                
                updateConnectionStatus(true, 'ready');
                
                window.install = function(url, name) {
                    console.log('INSTALL_MOD:' + url + ':' + installMode);
                };
                
                console.log('‚úì –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω—ã');
            })();
            """
            
            self.web.page().runJavaScript(inject_js)
            print("üîå JS –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –≤–Ω–µ–¥—Ä–µ–Ω")

    def start_install(self, url, mode):
        print(f"üöÄ –£—Å—Ç–∞–Ω–æ–≤–∫–∞: {url} (—Ä–µ–∂–∏–º: {mode})")
        
        install_path = self.get_install_path(mode)
        
        if not install_path:
            print("‚ùå –ü—É—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω")
            return
        
        print(f"üìÇ –ü—É—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏: {install_path}")
        
        self.web.page().runJavaScript("showModal();")
        
        self.installer = Installer(url, install_path)
        self.installer.done.connect(self.on_done)
        self.installer.progress.connect(self.on_progress)
        self.installer.start()

    def on_progress(self, percent, message):
        safe_message = message.replace("'", "\\'").replace('"', '\\"').replace('\n', '\\n')
        
        js = f"updateProgress({percent}, '{safe_message}');"
        self.web.page().runJavaScript(js)
        print(f"  {message} ({percent}%)")

    def on_done(self, success, message):
        print(f"{'‚úÖ' if success else '‚ùå'} –ó–∞–≤–µ—Ä—à–µ–Ω–æ")
        
        safe_message = message.replace("'", "\\'").replace('"', '\\"').replace('\n', ' ')
        
        if success:
            js = f"showSuccess('{safe_message}');"
        else:
            js = f"showError('{safe_message}');"
        
        self.web.page().runJavaScript(js)


if __name__ == "__main__":
    app = QApplication(sys.argv)
    app.setApplicationName("Asstrallity")
    
    window = MainWindow()
    window.show()
    
    sys.exit(app.exec())
